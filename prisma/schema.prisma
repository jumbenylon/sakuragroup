// v2.2 â€” Final Production Schema (Referential Integrity Update)

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      String   @default("USER")
  status    String   @default("ACTIVE")
  balance   Int      @default(0)
  smsRate   Int      @default(25)

  senderIds SenderId[]
  campaigns Campaign[]
  messages  MessageLog[]
  apiKeys   ApiKey[]
  sessions  Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Session {
  id           String   @id @default(uuid())
  token        String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
}

model ApiKey {
  id        String   @id @default(uuid())
  key       String   @unique 
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model SenderId {
  id          String   @id @default(uuid())
  name        String
  status      String   @default("PENDING")
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  approvedBy  String?
  approvedAt  DateTime?
  rejectedBy  String?
  rejectedAt  DateTime?

  campaigns   Campaign[]
  messages    MessageLog[]

  createdAt   DateTime @default(now())

  @@unique([name, userId]) 
}

model Campaign {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id])
  
  // SetNull on SenderId deletion ensures campaign history remains
  senderId         String?
  sender           SenderId?    @relation(fields: [senderId], references: [id], onDelete: SetNull)

  status           String       
  totalRecipients  Int
  totalSegments    Int
  totalCost        Int          
  
  messages         MessageLog[]
  createdAt        DateTime     @default(now())
}

model MessageLog {
  id               String    @id @default(uuid())
  campaignId       String?   
  campaign         Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  userId           String
  user             User      @relation(fields: [userId], references: [id])
  
  // SetNull ensures financial records exist even if the Brand ID is removed
  senderId         String?
  sender           SenderId? @relation(fields: [senderId], references: [id], onDelete: SetNull)

  recipient        String
  message          String
  segmentCount     Int
  costToTenant     Int       
  costToAdmin      Int       @default(19) 
  status           String    

  providerMessageId String?
  providerError      String?

  scheduledAt      DateTime?
  sentAt           DateTime?
  createdAt        DateTime  @default(now())
}
