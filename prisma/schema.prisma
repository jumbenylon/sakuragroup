// v2.1 â€” Refined Enterprise Messaging Engine

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      String   @default("USER")
  status    String   @default("ACTIVE")
  balance   Int      @default(0) // Stored in TZS minor units
  smsRate   Int      @default(25)

  senderIds SenderId[]
  campaigns Campaign[]
  messages  MessageLog[]
  apiKeys   ApiKey[]
  sessions  Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Session {
  id           String   @id @default(uuid())
  token        String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
}

model ApiKey {
  id        String   @id @default(uuid())
  key       String   @unique 
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model SenderId {
  id          String   @id @default(uuid())
  name        String
  status      String   @default("PENDING")
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  approvedBy  String?
  approvedAt  DateTime?
  rejectedBy  String?
  rejectedAt  DateTime?

  campaigns   Campaign[]
  messages    MessageLog[]

  createdAt   DateTime @default(now())

  @@unique([name, userId]) // Prevents duplicate requests from same user
}

model Campaign {
  id               String       @id @default(uuid())
  userId           String
  user             User         @relation(fields: [userId], references: [id])
  senderId         String
  sender           SenderId     @relation(fields: [senderId], references: [id])

  status           String       // DRAFT | QUEUED | PROCESSING | COMPLETE
  totalRecipients  Int
  totalSegments    Int
  totalCost        Int          // minor units
  
  messages         MessageLog[]
  createdAt        DateTime     @default(now())
}

model MessageLog {
  id               String    @id @default(uuid())
  campaignId       String?   // Optional for single API sends
  campaign         Campaign? @relation(fields: [campaignId], references: [id])
  userId           String
  user             User      @relation(fields: [userId], references: [id])
  senderId         String?
  sender           SenderId? @relation(fields: [senderId], references: [id])

  recipient        String
  message          String
  segmentCount     Int
  costToTenant     Int       // What the reseller paid
  costToAdmin      Int       @default(19) // What you paid (for margin tracking)
  status           String    // PENDING | SENT | FAILED

  providerMessageId String?
  providerError      String?

  scheduledAt      DateTime?
  sentAt           DateTime?
  createdAt        DateTime  @default(now())
}
